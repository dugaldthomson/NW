%%function genSPD

%------------------------------------------------------------------------------
% hyd.mat contains freq_vector and psd_matrix
%------------------------------------------------------------------------------

%------------------------------------------------------------------------------
% Get the frequencies we want
%------------------------------------------------------------------------------
len_freq_vector = length(frequency);

%------------------------------------------------------------------------------
% Histogram (PDF) bin width
%------------------------------------------------------------------------------
hind = 0.1;

%------------------------------------------------------------------------------
% psd_matrix stores the PSD values. For each FFT file we will store the PSD 
% value from 250Hz to 100000Hz in 250Hz increments. So we have 400 bins of 
% 250Hz size in total (as we top out at 100kHz).
% spda is Log10
%------------------------------------------------------------------------------
spda = PSD;

%------------------------------------------------------------------------------
% Minimum dB level rounded down to nearest 10
%------------------------------------------------------------------------------
%mindB = min(min(spda(spda>-Inf)))
mindB = floor(min(min(spda))/10) * 10;
                        
%------------------------------------------------------------------------------
% Maximum dB level rounded up to nearest 10
%------------------------------------------------------------------------------
maxdB = ceil(max(max(spda))/10) * 10;

%------------------------------------------------------------------------------
% dB values at which to calculate empirical PDF
%------------------------------------------------------------------------------
dB_vector = mindB:hind:maxdB;

%------------------------------------------------------------------------------
% Compute values
%------------------------------------------------------------------------------
disp('Computation begun.')

%------------------------------------------------------------------------------
% Calculate linear mean
%------------------------------------------------------------------------------
linear_mean = 10 * log10(mean(10.^(spda/10),2));
disp('Linear mean computed')

%------------------------------------------------------------------------------
% Array of percentiles
%------------------------------------------------------------------------------
p = prctile(spda,1:99,2);
disp('Percentiles computed')

%------------------------------------------------------------------------------
% Number of files must match what was in flist.txt
%------------------------------------------------------------------------------
%number_of_files
number_of_files = 6287;
size(spda)
size(dB_vector)

%------------------------------------------------------------------------------
% SPD array
%------------------------------------------------------------------------------
d = hist(spda',dB_vector)/(hind*(number_of_files*5-1));
disp('d computed.')

%-----------------------------------------------------------------------------
% Suppress plotting of empty hist bins
%-----------------------------------------------------------------------------
d(d == 0) = NaN; 

d = [d d(:,length(d(1,:)))];

%freq_vector
%len_freq_vector
disp('size(d)')
size(d)

%------------------------------------------------------------------------------
% Axis array for SPD pcolor plot
%------------------------------------------------------------------------------
[X,Y] = meshgrid([frequency;frequency(len_freq_vector)]-0.5,dB_vector);  
disp('SPD meshgrid computed.')

%------------------------------------------------------------------------------
% Plot
%------------------------------------------------------------------------------
figure(1)

%------------------------------------------------------------------------------
% SPD
%------------------------------------------------------------------------------
g = pcolor(X,Y,double(d));
set(g,'LineStyle','none')
colorbar

hold on

%------------------------------------------------------------------------------
% Percentiles
%------------------------------------------------------------------------------
plot(frequency,p(:,99),'k','linewidth',2)
plot(frequency,p(:,1),'k','linewidth',2)
%semilogx(frequency,p(:,99),'k','linewidth',2)
%semilogx(frequency,p(:,1),'k','linewidth',2)

%------------------------------------------------------------------------------
% Linear mean
%------------------------------------------------------------------------------
plot(frequency,linear_mean,'m','linewidth',2)
%semilogx(frequency,linear_mean,'m','linewidth',2)

%-----------------------------------------------------------------------------
% Set color axis
%-----------------------------------------------------------------------------
caxis([0 0.05])

%------------------------------------------------------------------------------
% Set graph labels
%------------------------------------------------------------------------------
title(['Spectral Probability Density for March 2019' ])
xlabel('Frequency [ Hz ]')
ylabel('PSD [ dB re 1 \muPa^2 Hz^-^1 ]')
set(gca,'XScale','linear','TickDir','out','layer','top')
%set(gca,'XScale','log','TickDir','out','layer','top')
set(colorbar,'fontsize',14,'fontname','Arial')
ylabel(colorbar,'Empirical Probability Density')
%ylim([40 130])
ylim([mindB maxdB])
%xlim([1 1250])
%xlim([min(frequency) max(frequency)])
grid

% end
